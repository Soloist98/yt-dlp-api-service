# TODO - 项目改进和优化清单

## 🔴 高优先级 - 安全性问题

### 认证和授权
- [ ] 添加API认证机制（API Key / JWT Token）
- [ ] 实现用户权限管理
- [ ] 添加速率限制（Rate Limiting）防止滥用
- [ ] 实现IP白名单/黑名单功能

### 输入验证和安全
- [ ] **路径遍历漏洞修复** - 验证和清理 `output_path` 参数，防止写入任意路径
- [ ] URL验证 - 检查URL格式和协议白名单
- [ ] 添加文件大小限制配置
- [ ] 添加磁盘空间检查，防止空间耗尽
- [ ] 移除硬编码的特殊站点处理（pornhub），改为配置化
- [ ] DELETE /tasks 端点添加确认机制或管理员权限

## 🟠 高优先级 - 核心功能

### 任务管理增强
- [ ] 实现任务取消功能
- [ ] 添加下载进度跟踪（使用yt-dlp的progress_hooks）
- [ ] 实现失败任务的重试机制（可配置重试次数）
- [ ] 添加任务优先级队列
- [ ] 实现并发下载数量限制（全局配置）
- [ ] 添加任务超时机制
- [ ] 实现任务暂停/恢复功能

### 资源管理
- [ ] 使用全局 ThreadPoolExecutor 替代每次创建新的
- [ ] 添加下载速度限制配置
- [ ] 实现自动清理过期任务和文件的机制
- [ ] 添加存储配额管理

## 🟡 中优先级 - 代码质量

### 日志和监控
- [ ] 替换所有 `print` 为结构化日志（使用 `logging` 或 `loguru`）
- [ ] 添加不同级别的日志（DEBUG, INFO, WARNING, ERROR）
- [ ] 实现日志轮转和归档
- [ ] 添加 `/health` 健康检查端点
- [ ] 添加 `/metrics` 端点（Prometheus格式）
- [ ] 记录关键操作的审计日志

### 配置管理
- [ ] 创建配置文件系统（使用 `pydantic-settings`）
- [ ] 支持环境变量配置
- [ ] 创建 `.env.example` 文件
- [ ] 配置项包括：
  - 数据库路径
  - 默认下载路径
  - 最大并发数
  - 线程池大小
  - 日志级别
  - API认证密钥

### 数据库优化
- [ ] 迁移到异步数据库驱动（`aiosqlite`）
- [ ] 实现数据库连接池
- [ ] 添加数据库索引（url, status, timestamp）
- [ ] 实现数据库迁移系统（使用 `alembic`）
- [ ] 添加数据库备份功能

### 错误处理
- [ ] 统一错误响应格式
- [ ] 创建自定义异常类
- [ ] 改进异常处理逻辑，提供更详细的错误信息
- [ ] 添加全局异常处理器

### 代码规范
- [ ] 为所有函数添加完整的 docstring
- [ ] 统一代码语言（建议注释用英文或全部用中文）
- [ ] 添加类型提示到所有函数
- [ ] 使用 `black` 格式化代码
- [ ] 使用 `pylint` / `flake8` 进行代码检查
- [ ] 使用 `mypy` 进行类型检查

## 🟢 中优先级 - 功能增强

### API功能
- [ ] 实现 WebSocket 支持，实时推送下载进度
- [ ] 添加任务搜索和过滤功能（按状态、日期、URL等）
- [ ] 实现分页查询（GET /tasks）
- [ ] 添加任务统计端点（总数、成功率、失败率等）
- [ ] 支持下载字幕和缩略图
- [ ] 支持自定义文件命名模板
- [ ] 添加批量删除任务功能
- [ ] 实现任务导出功能（JSON/CSV）

### 性能优化
- [ ] 添加视频信息查询缓存（Redis或内存缓存）
- [ ] 优化批量操作性能（使用异步并发）
- [ ] 实现文件流式传输优化
- [ ] 添加CDN支持配置

### 用户体验
- [ ] 添加任务创建时间和完成时间字段
- [ ] 显示预估下载时间
- [ ] 添加下载历史统计
- [ ] 支持任务标签和分类

## 🔵 低优先级 - 测试和文档

### 测试
- [ ] 编写单元测试（使用 `pytest`）
- [ ] 编写集成测试
- [ ] 添加API端点测试
- [ ] 实现测试覆盖率报告（目标 >80%）
- [ ] 添加性能测试

### 文档
- [ ] 完善API文档（OpenAPI/Swagger描述）
- [ ] 添加使用示例和教程
- [ ] 创建开发者文档
- [ ] 添加架构设计文档
- [ ] 创建故障排查指南

## 🟣 低优先级 - 部署和运维

### Docker优化
- [ ] 使用多阶段构建优化镜像大小
- [ ] 使用非root用户运行容器
- [ ] 创建 `docker-compose.yml` 文件
- [ ] 添加健康检查到Dockerfile
- [ ] 优化层缓存

### 生产环境
- [ ] 创建生产环境配置
- [ ] 添加 HTTPS 支持
- [ ] 实现优雅关闭（Graceful Shutdown）
- [ ] 添加进程管理（使用 `supervisor` 或 `systemd`）
- [ ] 配置反向代理示例（Nginx）

### CI/CD
- [ ] 创建 GitHub Actions 工作流
- [ ] 自动化测试流程
- [ ] 自动化Docker镜像构建和推送
- [ ] 添加代码质量检查门禁
- [ ] 实现自动化部署

### 监控和告警
- [ ] 集成 Prometheus 监控
- [ ] 添加 Grafana 仪表板
- [ ] 配置告警规则（磁盘空间、失败率等）
- [ ] 实现错误追踪（Sentry）

## 📋 架构改进

### 代码架构
- [ ] 引入依赖注入框架
- [ ] 实现仓储模式（Repository Pattern）
- [ ] 分离业务逻辑和数据访问层
- [ ] 创建服务层（Service Layer）
- [ ] 实现事件驱动架构（可选）

### API设计
- [ ] 实现API版本控制（/v1/, /v2/）
- [ ] 使用RESTful最佳实践
- [ ] 添加CORS配置
- [ ] 实现请求ID追踪

## 🐛 已知问题修复

### Bug修复
- [ ] `process_download_task` 中每次创建新的 ThreadPoolExecutor 效率低
- [ ] 数据库连接未使用连接池，高并发下可能出现问题
- [ ] `task_exists` 查询可能返回已失败的任务，导致重复下载失败
- [ ] `NormalizeString` 函数可能导致文件名冲突
- [ ] 文件下载端点没有处理大文件的流式传输

### 代码清理
- [ ] 移除未使用的导入
- [ ] 清理注释掉的代码
- [ ] 统一命名规范
- [ ] 重构过长的函数

## 📝 其他建议

### 可选功能
- [ ] 支持多种数据库（PostgreSQL, MySQL）
- [ ] 实现分布式任务队列（Celery + Redis）
- [ ] 添加Web管理界面
- [ ] 支持插件系统
- [ ] 实现多租户支持
- [ ] 添加国际化支持（i18n）
- [ ] 支持视频转码功能
- [ ] 实现下载调度（定时下载）

### 性能基准
- [ ] 建立性能基准测试
- [ ] 记录不同场景下的性能指标
- [ ] 定期进行性能回归测试

---

## 优先级说明

- 🔴 **高优先级** - 安全性和核心功能问题，应立即处理
- 🟠 **高优先级** - 影响用户体验和系统稳定性
- 🟡 **中优先级** - 代码质量和可维护性改进
- 🟢 **中优先级** - 功能增强
- 🔵 **低优先级** - 测试和文档
- 🟣 **低优先级** - 部署和运维优化

## 建议实施顺序

1. **第一阶段**：安全性修复（路径验证、认证、速率限制）
2. **第二阶段**：核心功能完善（任务管理、日志系统、配置管理）
3. **第三阶段**：性能优化（数据库、线程池、缓存）
4. **第四阶段**：测试和文档
5. **第五阶段**：部署和监控
